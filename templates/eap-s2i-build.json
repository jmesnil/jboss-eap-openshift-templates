{
    "kind": "Template",
    "apiVersion": "v1",
    "metadata": {
        "annotations": {
            "iconClass": "icon-eap",
            "tags": "eap,eap-xp,javaee,java,jboss",
            "version": "1.0",
            "openshift.io/display-name": "Template to build JBoss EAP application using S2I",
            "openshift.io/provider-display-name": "Red Hat, Inc.",
            "description": "This template build an image based on JBoss EAP from a Git repository using S2I.",
            "template.openshift.io/long-description": "This template build an image based on JBoss EAP using S2I.",
            "template.openshift.io/documentation-url": "https://access.redhat.com/documentation/en/red-hat-jboss-enterprise-application-platform/",
            "template.openshift.io/support-url": "https://access.redhat.com"
        },
        "name": "eap-s2i-build"
    },
    "labels": {
        "template": "eap-s2i-build",
        "xpaas": "1.0"
    },
    "message": "A new ImageStream for your JBoss EAP XP based application has been created in your project.",
    "parameters": [
        {
            "displayName": "Image Stream Name",
            "description": "The name for the application ImageStream.",
            "name": "IMAGE_NAME",
            "required": true
        },
        {
            "displayName": "EAP XP Image Name",
            "description": "EAP XP imagestream tag to be used, example: jboss-eap-xp1-openjdk11-openshift:1.0",
            "name": "EAP_IMAGE_NAME",
            "value": "jboss-eap-xp1-openjdk11-openshift:1.0",
            "required": true
        },
        {
            "displayName": "EAP XP Runtime Image Name",
            "description": "EAP XP Runtime imagestream tag to be used, example: jboss-eap-xp1-openjdk11-runtime-openshift:1.0",
            "name": "EAP_RUNTIME_IMAGE_NAME",
            "value": "jboss-eap-xp1-openjdk11-runtime-openshift:1.0",
            "required": true
        },
        {
            "displayName": "Git Repository URL",
            "description": "Git source URI for application",
            "name": "SOURCE_REPOSITORY_URL",
            "value": "https://github.com/jboss-developer/jboss-eap-quickstarts.git",
            "required": true
        },
        {
            "displayName": "Git Reference",
            "description": "Git branch/tag reference",
            "name": "SOURCE_REPOSITORY_REF",
            "value": "7.3.x-openshift",
            "required": false
        },
        {
            "displayName": "Context Directory",
            "description": "Path within Git project to build; empty for root project directory.",
            "name": "CONTEXT_DIR",
            "value": "helloworld-rs",
            "required": false
        },
        {
            "displayName": "Galleon layers",
            "description": "Comma separated list of Galleon layers to provision a server.",
            "name": "GALLEON_PROVISION_LAYERS",
            "required": false
        },
        {
            "displayName": "Github Webhook Secret",
            "description": "GitHub trigger secret",
            "name": "GITHUB_WEBHOOK_SECRET",
            "from": "[a-zA-Z0-9]{8}",
            "generate": "expression",
            "required": true
        },
        {
            "displayName": "Generic Webhook Secret",
            "description": "Generic build trigger secret",
            "name": "GENERIC_WEBHOOK_SECRET",
            "from": "[a-zA-Z0-9]{8}",
            "generate": "expression",
            "required": true
        },
        {
            "displayName": "EAP ImageStream Namespace",
            "description": "Namespace in which the ImageStreams for Red Hat Middleware images are installed. These ImageStreams are normally installed in the openshift namespace. You should only need to modify this if you've installed the ImageStreams in a different namespace/project.",
            "name": "EAP_IMAGE_STREAM_NAMESPACE",
            "value": "openshift",
            "required": true
        },
        {
            "displayName": "Maven mirror URL",
            "description": "Maven mirror to use for S2I builds",
            "name": "MAVEN_MIRROR_URL",
            "value": "",
            "required": false
        },
        {
            "displayName": "Maven Additional Arguments",
            "description": "Maven additional arguments to use for S2I builds",
            "name": "MAVEN_ARGS_APPEND",
            "value": "-Dcom.redhat.xpaas.repo.jbossorg",
            "required": false
        },
        {
            "description": "List of directories from which archives will be copied into the deployment folder. If unspecified, all archives in /target will be copied.",
            "name": "ARTIFACT_DIR",
            "value": "",
            "required": false
        }
    ],
    "objects": [
        {
            "kind": "ImageStream",
            "apiVersion": "v1",
            "metadata": {
                "name": "${IMAGE_NAME}"
            }
        },
        {
            "kind": "ImageStream",
            "apiVersion": "v1",
            "metadata": {
                "name": "${IMAGE_NAME}-build-artifacts"
            }
        },
        {
            "kind": "BuildConfig",
            "apiVersion": "v1",
            "metadata": {
                "name": "${IMAGE_NAME}-build-artifacts"
            },
            "spec": {
                "source": {
                    "type": "Git",
                    "git": {
                        "uri": "${SOURCE_REPOSITORY_URL}",
                        "ref": "${SOURCE_REPOSITORY_REF}"
                    },
                    "contextDir": "${CONTEXT_DIR}"
                },
                "strategy": {
                    "type": "Source",
                    "sourceStrategy": {
                        "env": [
                            {
                                "name": "MAVEN_MIRROR_URL",
                                "value": "${MAVEN_MIRROR_URL}"
                            },
                            {
                                "name": "MAVEN_ARGS_APPEND",
                                "value": "${MAVEN_ARGS_APPEND}"
                            },
                            {
                                "name": "GALLEON_PROVISION_LAYERS",
                                "value": "${GALLEON_PROVISION_LAYERS}"
                            },
                            {
                                "name": "GALLEON_PROVISION_DEFAULT_FAT_SERVER",
                                "value": "true"
                            },
                            {
                                "name": "ARTIFACT_DIR",
                                "value": "${ARTIFACT_DIR}"
                            }
                        ],
                        "forcePull": true,
                        "incremental": true,
                        "from": {
                            "kind": "ImageStreamTag",
                            "namespace": "${EAP_IMAGE_STREAM_NAMESPACE}",
                            "name": "${EAP_IMAGE_NAME}"
                        }
                    }
                },
                "output": {
                    "to": {
                        "kind": "ImageStreamTag",
                        "name": "${IMAGE_NAME}-build-artifacts:latest"
                    }
                },
                "triggers": [
                    {
                        "type": "GitHub",
                        "github": {
                            "secret": "${GITHUB_WEBHOOK_SECRET}"
                        }
                    },
                    {
                        "type": "Generic",
                        "generic": {
                            "secret": "${GENERIC_WEBHOOK_SECRET}"
                        }
                    },
                    {
                        "type": "ImageChange",
                        "imageChange": {}
                    },
                    {
                        "type": "ConfigChange"
                    }
                ]
            }
        },
        {
            "apiVersion": "v1",
            "kind": "BuildConfig",
            "metadata": {
                "name": "${IMAGE_NAME}"
            },
            "spec": {
                "output": {
                    "to": {
                        "kind": "ImageStreamTag",
                        "name": "${IMAGE_NAME}:latest"
                    }
                },
                "source": {
                    "dockerfile": "FROM ${EAP_RUNTIME_IMAGE_NAME}\nCOPY /server $JBOSS_HOME\nUSER root\nRUN chown -R jboss:root $JBOSS_HOME && chmod -R ug+rwX $JBOSS_HOME\nUSER jboss\nCMD $JBOSS_HOME/bin/openshift-launch.sh",
                    "images": [
                        {
                            "from": {
                                "kind": "ImageStreamTag",
                                "name": "${IMAGE_NAME}-build-artifacts:latest"
                            },
                            "paths": [
                                {
                                    "sourcePath": "/s2i-output/server/",
                                    "destinationDir": "."
                                }
                            ]
                        }
                    ]
                },
                "strategy": {
                    "dockerStrategy": {
                        "imageOptimizationPolicy": "SkipLayers",
                        "from": {
                            "kind": "ImageStreamTag",
                            "name": "${EAP_RUNTIME_IMAGE_NAME}",
                            "namespace": "${EAP_IMAGE_STREAM_NAMESPACE}"
                        }
                    },
                    "type": "Docker"
                },
                "triggers": [
                    {
                        "type": "ImageChange",
                        "imageChange": {
                            "from": {
                                "kind": "ImageStreamTag",
                                "name": "${IMAGE_NAME}-build-artifacts:latest"
                            }
                        }
                    },
                    {
                        "type": "ConfigChange"
                    }
                ]
            }
        }
    ]
}
